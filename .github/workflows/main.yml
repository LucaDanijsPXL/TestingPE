name: Build and Push Docker Images to GHCR

# Trigger the workflow on tag creation
on:
  push:
    tags:
      - 'v*'  # This will match tags like v0.8, v1.0, etc.

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout the code
        uses: actions/checkout@v2

      # Step 2: Set up Docker Buildx (for multi-platform support)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      # Step 3: Log in to GitHub Container Registry (GHCR)
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}  # Store your GHCR PAT in secrets
          registry: ghcr.io  # Specify GitHub Container Registry

      # Step 4: Determine the tag prefix (TEST_ or PROD_)
      - name: Determine Tag Prefix
        id: tag_prefix
        run: |
          TAG=${GITHUB_REF##*/}  # Extract tag name
          TAG=${TAG,,}  # Convert tag to lowercase
          echo "TAG=${TAG}"  # Output tag for debugging
          if [[ "$TAG" == "v0.8" ]]; then
            echo "Tag is TEST"
            echo "TAG_PREFIX=TEST_" >> $GITHUB_ENV
          else
            echo "Tag is PROD"
            echo "TAG_PREFIX=PROD_" >> $GITHUB_ENV
          fi

      # Step 5: Build and push frontend Docker image
      - name: Build and push frontend Docker image
        run: |
          IMAGE_TAG=${{ env.TAG_PREFIX }}${{ env.TAG }}
          docker build -t ghcr.io/${{ github.repository_owner }}/pxlcensor-frontend-luca:${IMAGE_TAG} ./frontend
          docker push ghcr.io/${{ github.repository_owner }}/pxlcensor-frontend-luca:${IMAGE_TAG}

      # Step 6: Build and push API Docker image
      - name: Build and push API Docker image
        run: |
          IMAGE_TAG=${{ env.TAG_PREFIX }}${{ env.TAG }}
          docker build -t ghcr.io/${{ github.repository_owner }}/pxlcensor-api-luca:${IMAGE_TAG} ./api
          docker push ghcr.io/${{ github.repository_owner }}/pxlcensor-api-luca:${IMAGE_TAG}

      # Step 7: Build and push processor Docker image
      - name: Build and push processor Docker image
        run: |
          IMAGE_TAG=${{ env.TAG_PREFIX }}${{ env.TAG }}
          docker build -t ghcr.io/${{ github.repository_owner }}/pxlcensor-processor-luca:${IMAGE_TAG} ./processor
          docker push ghcr.io/${{ github.repository_owner }}/pxlcensor-processor-luca:${IMAGE_TAG}

      # Step 8: Build and push media Docker image
      - name: Build and push media Docker image
        run: |
          IMAGE_TAG=${{ env.TAG_PREFIX }}${{ env.TAG }}
          docker build -t ghcr.io/${{ github.repository_owner }}/pxlcensor-media-luca:${IMAGE_TAG} ./media
          docker push ghcr.io/${{ github.repository_owner }}/pxlcensor-media-luca:${IMAGE_TAG}
