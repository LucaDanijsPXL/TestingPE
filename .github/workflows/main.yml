name: Build and Push Docker Images to GHCR

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., TEST_v0.8)'
        required: true
        default: 'TEST_v0.8'  # Default version tag

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository code
      - name: Checkout code
        uses: actions/checkout@v2

      # Step 2: Add the org.opencontainers.image.source label to the Dockerfile
      - name: Modify Dockerfile to include org.opencontainers.image.source label
        run: |
          echo 'LABEL org.opencontainers.image.source="https://github.com/${{ github.repository }}"' >> ./frontend/Dockerfile
          echo 'LABEL org.opencontainers.image.source="https://github.com/${{ github.repository }}"' >> ./api/Dockerfile
          echo 'LABEL org.opencontainers.image.source="https://github.com/${{ github.repository }}"' >> ./processor/Dockerfile
          echo 'LABEL org.opencontainers.image.source="https://github.com/${{ github.repository }}"' >> ./media/Dockerfile
      # Step 3: Log in to GitHub Container Registry (GHCR) using Personal Access Token (PAT)
      - name: Log in to GHCR using PAT
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}  # GitHub username
          password: ${{ secrets.GHCR_TOKEN }}  # PAT stored in GitHub Secrets

      # Step 4: Build and push frontend Docker image
      - name: Build frontend Docker image
        run: |
          REPO_NAME=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')  # Convert repo name to lowercase
          TAG=${{ github.event.inputs.version }}  # Use version input as tag
          
          # Build and push Docker image
          docker build -t ghcr.io/$REPO_NAME/pxlcensor-frontend:$TAG ./frontend
          docker push ghcr.io/$REPO_NAME/pxlcensor-frontend:$TAG
      # Step 5: Build and push API Docker image
      - name: Build API Docker image
        run: |
          REPO_NAME=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')  # Convert repo name to lowercase
          TAG=${{ github.event.inputs.version }}  # Use version input as tag
          docker build -t ghcr.io/$REPO_NAME/pxlcensor-api:$TAG ./api
          docker push ghcr.io/$REPO_NAME/pxlcensor-api:$TAG
      # Step 6: Build and push processor Docker image
      - name: Build processor Docker image
        run: |
          REPO_NAME=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')  # Convert repo name to lowercase
          TAG=${{ github.event.inputs.version }}  # Use version input as tag
          docker build -t ghcr.io/$REPO_NAME/pxlcensor-processor:$TAG ./processor
          docker push ghcr.io/$REPO_NAME/pxlcensor-processor:$TAG
      # Step 7: Build and push media Docker image (to ensure it's tagged correctly)
      - name: Build media Docker image
        run: |
          REPO_NAME="lucadanijspxl/testingpe"  # Set the repository to lowercase
          TAG=${{ github.event.inputs.version }}  # Use version input as tag
          docker build -t ghcr.io/$REPO_NAME/pxlcensor-media:$TAG ./media
          docker push ghcr.io/$REPO_NAME/pxlcensor-media:$TAG
